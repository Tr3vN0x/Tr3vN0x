<script>
// --- SECURITY WARNING ---
// The current script stores the user's password directly in localStorage for demonstration.
// This is HIGHLY INSECURE and MUST NOT be used in a production application.
// A real application requires a secure backend for password hashing and secure token-based authentication.

// ===== State Management & Loader =====
let categories = {}; // Define globally, fill later
let viewCounts = {};
let currentUser = null;

window.addEventListener('load', () => {
    // Hide Loader
    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'none';

    // Initialize State
    viewCounts = JSON.parse(localStorage.getItem('viewCounts')) || {};
    currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

    // Video Data (Defined here to ensure it's available after the load event)
    categories = {
        trending: [
            { id: "92y9uaQMIa8", title: "I PLAYED ROBLOX DEAD BY DAYLIGHT (IT WAS SCARY!)" },
            { id: "ZiEd3RoiKtk", title: "Who Is TR3VN0X? (Robloxâ€™s Funniest New YouTuber ðŸ’€)" },
            { id: "Uwwga_CiFqc", title: "Why Is Flee the Facility THIS Stressful?! ðŸ˜¤ðŸ”¥" },
            { id: "J-W0Vfrc26U", title: "Nobody Could Stop Meâ€¦ (Sniper Only Challenge ðŸ’€)" }
        ],
        latest: [
            { id: "92y9uaQMIa8", title: "I PLAYED ROBLOX DEAD BY DAYLIGHT (IT WAS SCARY!)" },
            { id: "kNkK_qclihc", title: "ROBLOXIAN HIGHSCHOOL *LIVE*" }
        ],
        recommended: [
            { id: "Sn4dyr5v7m0", title: "ROBLOX BREAKING POINT" },
            { id: "Uwwga_CiFqc", title: "Why Is Flee the Facility THIS Stressful?! ðŸ˜¤ðŸ”¥" },
            { id: "J-W0Vfrc26U", title: "Nobody Could Stop Meâ€¦ (Sniper Only Challenge ðŸ’€)" }
        ]
    };

    // Populate video cards and featured video
    populateVideos();
    updateAuthUI();
    prefillLogin();
    setupEventListeners();
});

// ===== Escape HTML utility =====
function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// ===== Video Cards Logic =====
function createVideoCard(video) {
    const card = document.createElement('div');
    card.className = 'video-card';
    const thumbnailUrl = `https://img.youtube.com/vi/${video.id}/hqdefault.jpg`;
    const videoTitle = escapeHtml(video.title);
    const initialViews = viewCounts[video.id] || 0;

    card.innerHTML = `
        <img class="thumbnail" src="${thumbnailUrl}" alt="${videoTitle}">
        <div class="video-info">
            <h3>${videoTitle}</h3>
            <p>Views: <span id="views-${video.id}">${initialViews}</span></p>
        </div>
    `;

    card.addEventListener('click', () => {
        // Replace card content with iframe
        card.innerHTML = `<iframe src="https://www.youtube.com/embed/${video.id}?autoplay=1" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`;

        // Update views count
        viewCounts[video.id] = (viewCounts[video.id] || 0) + 1;
        localStorage.setItem('viewCounts', JSON.stringify(viewCounts));

        // CRITICAL FIX: The span element is now gone, so we can't update its text.
        // For local display, you would typically need a system that updates the entire UI/reloads the section.
        // For this demo, we'll just ensure the localStorage is saved.
    }, { once: true }); // Use { once: true } to prevent multiple clicks on the same card from re-embedding the iframe.

    return card;
}

function populateVideos() {
    // Populate video cards
    for (const [cat, vids] of Object.entries(categories)) {
        const container = document.getElementById(cat);
        // Clear previous content before repopulating
        if (container) {
            container.innerHTML = '';
            vids.forEach(v => container.appendChild(createVideoCard(v)));
        }
    }

    // Featured video
    const featured = document.getElementById('featured');
    const firstTrending = categories.trending[0];
    if (featured && firstTrending) {
        // Safely set the featured video details
        const imgEl = featured.querySelector('img');
        const h2El = featured.querySelector('h2');
        if (imgEl) imgEl.src = `https://img.youtube.com/vi/${firstTrending.id}/maxresdefault.jpg`;
        if (h2El) h2El.innerText = `Featured: ${firstTrending.title}`;
    }
}

// ===== Utility Functions =====
function openAuth() {
    const authOverlay = document.getElementById('auth-overlay');
    if (authOverlay) {
        authOverlay.style.display = 'flex';
        authOverlay.setAttribute('aria-hidden', 'false');
    }
}

function closeAuthOverlay() {
    const authOverlay = document.getElementById('auth-overlay');
    if (authOverlay) {
        authOverlay.style.display = 'none';
        authOverlay.setAttribute('aria-hidden', 'true');
    }
}

function updateAuthUI() {
    const floatingAuthText = document.getElementById('floating-auth-text');
    const userBubble = document.getElementById('user-bubble');
    const bubbleName = document.getElementById('bubble-name');

    if (currentUser) {
        if (floatingAuthText) floatingAuthText.textContent = currentUser.username || 'Account';
        if (userBubble) userBubble.classList.add('show');
        if (bubbleName) bubbleName.textContent = currentUser.username || currentUser.email || 'User';
        closeAuthOverlay();
    } else {
        if (floatingAuthText) floatingAuthText.textContent = 'Login';
        if (userBubble) userBubble.classList.remove('show');
    }
}

function prefillLogin() {
    const saved = JSON.parse(localStorage.getItem('currentUser'));
    if (saved && saved.email) {
        const le = document.getElementById('login-email');
        if (le) le.value = saved.email;
    }
}


// ===== Event Listeners Setup =====
function setupEventListeners() {
    // DOM references
    const floatingBtn = document.getElementById('floating-auth');
    const authOverlay = document.getElementById('auth-overlay');
    const closeAuth = document.getElementById('close-auth');
    const loginTab = document.getElementById('login-tab');
    const signupTab = document.getElementById('signup-tab');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const togglePassButtons = document.querySelectorAll('.toggle-pass');
    const logoutBtn = document.getElementById('logout-btn');
    const searchInput = document.getElementById('searchInput');
    const bubbleName = document.getElementById('bubble-name');

    // Toggle password visibility
    togglePassButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const input = document.getElementById(btn.dataset.target);
            if (!input) return;
            if (input.type === 'password') { input.type = 'text'; btn.textContent = 'ðŸ™ˆ'; }
            else { input.type = 'password'; btn.textContent = 'ðŸ‘ï¸'; }
        });
    });

    // Tabs
    if (loginTab && signupTab && loginForm && signupForm) {
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active'); signupTab.classList.remove('active');
            loginForm.classList.add('active'); signupForm.classList.remove('active');
        });
        signupTab.addEventListener('click', () => {
            signupTab.classList.add('active'); loginTab.classList.remove('active');
            signupForm.classList.add('active'); loginForm.classList.remove('active');
        });
    }

    // Open/close modal
    if (floatingBtn) floatingBtn.addEventListener('click', openAuth);
    if (closeAuth) closeAuth.addEventListener('click', closeAuthOverlay);
    if (authOverlay) authOverlay.addEventListener('click', e => { if (e.target === authOverlay) closeAuthOverlay(); });
    if (bubbleName) bubbleName.addEventListener('click', () => { openAuth(); if (loginTab) loginTab.click(); });

    // Signup
    if (signupForm) {
        signupForm.addEventListener('submit', e => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value.trim().toLowerCase();
            const password = document.getElementById('signup-password').value;
            const tagsRaw = document.getElementById('signup-tags').value.trim();

            if (!username || !email || !password) { alert('Please fill all fields.'); return; }
            if (password.length < 6) { alert('Password must be at least 6 characters long.'); return; } // Added basic validation

            const tags = tagsRaw.split(/\s+/).filter(Boolean).map(t => t.startsWith('#') ? t : `#${t}`);
            const user = { username, email, password, tags };

            // Store user, assuming one user for this demo
            localStorage.setItem('currentUser', JSON.stringify(user));
            currentUser = user;

            alert('Account created! You are now logged in.');
            updateAuthUI();
            closeAuthOverlay();
            signupForm.reset(); // Clear the form
        });
    }

    // Login
    if (loginForm) {
        loginForm.addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value;
            const saved = JSON.parse(localStorage.getItem('currentUser'));

            if (!saved) { alert('No account found. Please sign up first.'); return; }

            // Security Warning: This is a plain text comparison. DO NOT USE IN PRODUCTION.
            if (saved.email === email && saved.password === password) {
                currentUser = saved;
                alert('Login successful!');
                updateAuthUI();
                closeAuthOverlay();
            } else { alert('Incorrect email or password.'); }

            loginForm.reset(); // Clear the form
            document.getElementById('login-email').value = email; // Prefill email after reset
        });
    }

    // Logout
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateAuthUI();
            alert('Logged out.');
        });
    }

    // Search (Improved performance by checking DOM elements exist)
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            const term = searchInput.value.toLowerCase();
            document.querySelectorAll('.video-card').forEach(card => {
                const titleEl = card.querySelector('.video-info h3');
                if (!titleEl) return;
                const title = titleEl.innerText.toLowerCase();
                card.style.display = title.includes(term) ? '' : 'none';
            });
        });
    }

    // Accessibility: close modal on ESC
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAuthOverlay(); });
}

</script>
