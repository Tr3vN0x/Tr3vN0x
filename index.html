<script>
// ===== Loader =====
window.addEventListener('load', () => {
    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'none';
});

// ===== Video Data =====
const categories = {
    trending: [
        { id: "92y9uaQMIa8", title: "I PLAYED ROBLOX DEAD BY DAYLIGHT (IT WAS SCARY!)" },
        { id: "ZiEd3RoiKtk", title: "Who Is TR3VN0X? (Robloxâ€™s Funniest New YouTuber ðŸ’€)" },
        { id: "Uwwga_CiFqc", title: "Why Is Flee the Facility THIS Stressful?! ðŸ˜¤ðŸ”¥" },
        { id: "J-W0Vfrc26U", title: "Nobody Could Stop Meâ€¦ (Sniper Only Challenge ðŸ’€)" }
    ],
    latest: [
        { id: "92y9uaQMIa8", title: "I PLAYED ROBLOX DEAD BY DAYLIGHT (IT WAS SCARY!)" },
        { id: "kNkK_qclihc", title: "ROBLOXIAN HIGHSCHOOL *LIVE*" }
    ],
    recommended: [
        { id: "Sn4dyr5v7m0", title: "ROBLOX BREAKING POINT" },
        { id: "Uwwga_CiFqc", title: "Why Is Flee the Facility THIS Stressful?! ðŸ˜¤ðŸ”¥" },
        { id: "J-W0Vfrc26U", title: "Nobody Could Stop Meâ€¦ (Sniper Only Challenge ðŸ’€)" }
    ]
};

// ===== Escape HTML utility =====
function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// ===== Video Cards =====
let viewCounts = JSON.parse(localStorage.getItem('viewCounts')) || {};
function createVideoCard(video) {
    const card = document.createElement('div');
    card.className = 'video-card';
    const thumbnailUrl = `https://img.youtube.com/vi/${video.id}/hqdefault.jpg`;
    card.innerHTML = `
        <img class="thumbnail" src="${thumbnailUrl}" alt="${escapeHtml(video.title)}">
        <div class="video-info">
            <h3>${escapeHtml(video.title)}</h3>
            <p>Views: <span id="views-${video.id}">${viewCounts[video.id] || 0}</span></p>
        </div>
    `;
    card.addEventListener('click', () => {
        card.innerHTML = `<iframe src="https://www.youtube.com/embed/${video.id}?autoplay=1" allowfullscreen></iframe>`;
        viewCounts[video.id] = (viewCounts[video.id] || 0) + 1;
        localStorage.setItem('viewCounts', JSON.stringify(viewCounts));
    });
    return card;
}

// Populate video cards
for (const [cat, vids] of Object.entries(categories)) {
    const container = document.getElementById(cat);
    if (container) vids.forEach(v => container.appendChild(createVideoCard(v)));
}

// Featured video
const featured = document.getElementById('featured');
if (featured) {
    const firstTrending = categories.trending[0];
    if (firstTrending) {
        featured.querySelector('img').src = `https://img.youtube.com/vi/${firstTrending.id}/maxresdefault.jpg`;
        featured.querySelector('h2').innerText = `Featured: ${firstTrending.title}`;
    }
}

// ===== Search =====
const searchInput = document.getElementById('searchInput');
if (searchInput) {
    searchInput.addEventListener('input', () => {
        const term = searchInput.value.toLowerCase();
        document.querySelectorAll('.video-card').forEach(card => {
            const titleEl = card.querySelector('.video-info h3');
            if (!titleEl) return;
            const title = titleEl.innerText.toLowerCase();
            card.style.display = title.includes(term) ? '' : 'none';
        });
    });
}

// ===== Auth Modal =====
const floatingBtn = document.getElementById('floating-auth');
const authOverlay = document.getElementById('auth-overlay');
const closeAuth = document.getElementById('close-auth');
const loginTab = document.getElementById('login-tab');
const signupTab = document.getElementById('signup-tab');
const loginForm = document.getElementById('login-form');
const signupForm = document.getElementById('signup-form');
const togglePassButtons = document.querySelectorAll('.toggle-pass');
const floatingAuthText = document.getElementById('floating-auth-text');
const userBubble = document.getElementById('user-bubble');
const bubbleName = document.getElementById('bubble-name');
const logoutBtn = document.getElementById('logout-btn');

let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

// Helpers
function openAuth() { authOverlay.style.display = 'flex'; authOverlay.setAttribute('aria-hidden', 'false'); }
function closeAuthOverlay() { authOverlay.style.display = 'none'; authOverlay.setAttribute('aria-hidden', 'true'); }

// Toggle password visibility
togglePassButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        const input = document.getElementById(btn.dataset.target);
        if (!input) return;
        if (input.type === 'password') { input.type = 'text'; btn.textContent = 'ðŸ™ˆ'; }
        else { input.type = 'password'; btn.textContent = 'ðŸ‘ï¸'; }
    });
});

// Tabs
loginTab.addEventListener('click', () => {
    loginTab.classList.add('active'); signupTab.classList.remove('active');
    loginForm.classList.add('active'); signupForm.classList.remove('active');
});
signupTab.addEventListener('click', () => {
    signupTab.classList.add('active'); loginTab.classList.remove('active');
    signupForm.classList.add('active'); loginForm.classList.remove('active');
});

// Open/close modal
floatingBtn.addEventListener('click', openAuth);
closeAuth.addEventListener('click', closeAuthOverlay);
authOverlay.addEventListener('click', e => { if (e.target === authOverlay) closeAuthOverlay(); });

// Signup
signupForm.addEventListener('submit', e => {
    e.preventDefault();
    const username = document.getElementById('signup-username').value.trim();
    const email = document.getElementById('signup-email').value.trim().toLowerCase();
    const password = document.getElementById('signup-password').value;
    const tagsRaw = document.getElementById('signup-tags').value.trim();
    if (!username || !email || !password) { alert('Please fill all fields.'); return; }
    const tags = tagsRaw.split(/\s+/).filter(Boolean).map(t => t.startsWith('#') ? t : `#${t}`);
    const user = { username, email, password, tags };
    localStorage.setItem('currentUser', JSON.stringify(user));
    currentUser = user;
    alert('Account created! You are now logged in.');
    updateAuthUI();
    closeAuthOverlay();
});

// Login
loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const email = document.getElementById('login-email').value.trim().toLowerCase();
    const password = document.getElementById('login-password').value;
    const saved = JSON.parse(localStorage.getItem('currentUser'));
    if (!saved) { alert('No account found. Please sign up first.'); return; }
    if (saved.email === email && saved.password === password) {
        currentUser = saved;
        alert('Login successful!');
        updateAuthUI();
        closeAuthOverlay();
    } else { alert('Incorrect email or password.'); }
});

// Logout
logoutBtn.addEventListener('click', () => {
    currentUser = null;
    localStorage.removeItem('currentUser');
    updateAuthUI();
    alert('Logged out.');
});

// Update UI based on auth state
function updateAuthUI() {
    if (currentUser) {
        floatingAuthText.textContent = currentUser.username || 'Account';
        userBubble.classList.add('show');
        bubbleName.textContent = currentUser.username || currentUser.email || 'User';
        closeAuthOverlay();
    } else {
        floatingAuthText.textContent = 'Login';
        userBubble.classList.remove('show');
    }
}
updateAuthUI();

// Prefill login email if user exists
(function prefillLogin() {
    const saved = JSON.parse(localStorage.getItem('currentUser'));
    if (saved && saved.email) {
        const le = document.getElementById('login-email');
        if (le) le.value = saved.email;
    }
})();

// Accessibility: close modal on ESC
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAuthOverlay(); });

// User bubble click opens auth
bubbleName.addEventListener('click', () => { openAuth(); loginTab.click(); });

</script>
